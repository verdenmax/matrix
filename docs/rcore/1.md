# 操作系统

操作系统资源管理程序。解决访问冲突，确保公平使用。


- 可以了解计算机里面软硬件运行机制。
- 可以学习软硬件基础架构。
- 可以发现和修复难对付的bug。(因为os的bug很多 😄️)


单用户系统：操作系统=装载器+程序库。

批处理系统：操作系统=装载器 + 程序控制器 + 输出处理器。

多道程序系统：内存变大。操作系统=装载器 + 程序调度 + 内存管理 + 输出管理。

分时系统：多个程序分时使用cpu。操作系统=装载器 + 程序调度 + 内存管理 + 中断处理+ ...。

个人电脑：cpu利用率不再是最重要的关注点。重点是用户界面和多媒体功能。

分布式系统：关注点是利用率。重点是网络、存储、计算的效率。

操作系统是对物理资源的各种抽象，来提供出进程的运行环境。地址空间和文件成为进程管理的资源。进程就称为执行的一个抽象。


## 为什么是Linux？

开放源码，很好的文档，设计简洁

Linux 内核提供那些服务？

进程，内存分配，文件内容，文件名、目录，访问控制。用户、网络、时间、终端等等

虽然代码量很大，功能很多，但是系统调用接口并不是很多，几百的数量级。

为了支持复杂应用，提出了地址空间、进程抽象、文件抽象。

后来逐步提出进程间可通信，并发、管理设备。


## OS

作为OS来说，就可以假定自己处于 S-mode。这样可以对OS之下提供更大的灵活性，OS可以执行在用户态，当指向特权指令时，可以被更下层进行处理，即可进行虚拟化。

!!! note "RISC-V特权指令"

    特权指令以及相应的指令和CSR读写操作。
    
    - mret 机器模式返回
    - sret 监管者模式返回
    - wfi 等待终端(wait for interupt)
    - sfence.vma 虚拟地址屏障指令 barrier
    - fence.i  i-cache 屏障指令

## 文件系统

以进程为单位，对文件资源进行管理。数据持久保存。

虚拟文件系统，定义了一组所有文件系统都支持数据结构和接口。VFS.


支持崩溃一致性的文件系统，如何在断电或者系统崩溃的情况下更新持久数据结构。

理想的操作是将文件系统从一个一致状态原子地移动到另一个状态（inode，位图，新数据块被写入磁盘后。）

解决方案1:fscl 检查整个文件系统。主要进行健全性检查。

解决方案2:日志，对文件系统的扩展。在更新磁盘之前，写下一些标记，组织成为日志。然后组织成为一个transaction事务。






